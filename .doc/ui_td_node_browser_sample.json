{
  "uri": "ui://td/node-browser",
  "mimeType": "text/html",
  "text": "<!doctype html>\n<html lang=\"ja\">\n<head>\n  <meta charset=\"UTF-8\" />\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\" />\n  <title>TD Node Browser</title>\n  <style>\n    :root { color-scheme: light; }\n    * { box-sizing: border-box; }\n    body { font-family: \"Segoe UI\", sans-serif; margin: 0; padding: 16px; background: #0b1021; color: #e5e7eb; }\n    h1 { font-size: 20px; margin: 0 0 12px; }\n    .panel { background: #11162a; border: 1px solid #1f2a44; border-radius: 10px; padding: 12px; margin-bottom: 12px; }\n    .row { display: flex; gap: 12px; }\n    .column { flex: 1; min-width: 0; }\n    label { display: block; font-size: 12px; color: #9ca3af; margin-bottom: 4px; }\n    input[type=\"text\"], input[type=\"number\"] { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #253150; background: #0f152b; color: #e5e7eb; }\n    input[type=\"range\"] { width: 100%; }\n    button { padding: 8px 12px; border: 1px solid #2f3c5f; background: #1a2450; color: #e5e7eb; border-radius: 6px; cursor: pointer; }\n    button:hover { background: #223061; }\n    button:disabled { opacity: 0.6; cursor: not-allowed; }\n    .list { max-height: 240px; overflow: auto; border: 1px solid #1f2a44; border-radius: 8px; background: #0f152b; }\n    .list-item { padding: 8px 10px; border-bottom: 1px solid #1f2a44; cursor: pointer; }\n    .list-item:last-child { border-bottom: none; }\n    .list-item:hover { background: #1a2450; }\n    .list-item.active { background: #223061; border-left: 3px solid #58a6ff; }\n    .pill { display: inline-block; padding: 2px 8px; border-radius: 9999px; background: #1f2a44; color: #a5b4fc; font-size: 11px; margin-left: 6px; }\n    .small { font-size: 12px; color: #9ca3af; }\n    .muted { color: #6b7280; }\n    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }\n    .param-row { border: 1px solid #1f2a44; border-radius: 8px; padding: 10px; background: #0f152b; }\n    .param-header { display: flex; justify-content: space-between; align-items: center; gap: 8px; }\n    .param-controls { display: flex; align-items: center; gap: 8px; margin-top: 8px; }\n    .status { margin-top: 8px; font-size: 12px; color: #93c5fd; }\n    .error { color: #fca5a5; }\n    .success { color: #86efac; }\n  </style>\n</head>\n<body>\n  <h1>TouchDesigner Node Browser</h1>\n  <div class=\"panel\">\n    <div class=\"row\" style=\"align-items:flex-end; gap: 8px;\">\n      <div class=\"column\">\n        <label>Parent Path</label>\n        <input id=\"parentPath\" type=\"text\" value=\"/project1\" />\n      </div>\n      <div class=\"column\">\n        <label>Pattern</label>\n        <input id=\"pattern\" type=\"text\" value=\"*\" />\n      </div>\n      <div style=\"display:flex; gap: 8px;\">\n        <button id=\"loadNodes\">ノード取得</button>\n      </div>\n    </div>\n    <div id=\"nodesStatus\" class=\"status muted\"></div>\n    <div class=\"list\" id=\"nodesList\"></div>\n  </div>\n\n  <div class=\"panel\">\n    <div class=\"row\" style=\"gap: 12px;\">\n      <div class=\"column\">\n        <h2 style=\"margin:0 0 8px;\">パラメータ</h2>\n        <div id=\"selectedNode\" class=\"small muted\">ノードを選択してください</div>\n      </div>\n      <div class=\"column\" style=\"text-align:right;\">\n        <button id=\"refreshNode\" disabled>再取得</button>\n      </div>\n    </div>\n    <div id=\"paramsStatus\" class=\"status muted\"></div>\n    <div id=\"paramsContainer\" class=\"grid\"></div>\n  </div>\n\n  <script>\n    (function() {\n      const nodesList = document.getElementById(\"nodesList\");\n      const nodesStatus = document.getElementById(\"nodesStatus\");\n      const paramsContainer = document.getElementById(\"paramsContainer\");\n      const paramsStatus = document.getElementById(\"paramsStatus\");\n      const selectedNodeLabel = document.getElementById(\"selectedNode\");\n      const parentPathInput = document.getElementById(\"parentPath\");\n      const patternInput = document.getElementById(\"pattern\");\n      const refreshNodeBtn = document.getElementById(\"refreshNode\");\n\n      let nodes = [];\n      let selectedNode = null;\n      let messageCounter = 0;\n      const pending = new Map();\n\n      function nextMessageId() {\n        return \"ui-msg-\" + Date.now() + \"-\" + (messageCounter++);\n      }\n\n      window.addEventListener(\"message\", (event) => {\n        const data = event.data;\n        if (!data || typeof data !== \"object\") return;\n        if (data.type === \"ui-message-response\" && data.messageId && pending.has(data.messageId)) {\n          const entry = pending.get(data.messageId);\n          pending.delete(data.messageId);\n          if (data.payload && \"response\" in data.payload) {\n            entry.resolve(data.payload.response);\n          } else {\n            entry.resolve(undefined);\n          }\n        }\n      });\n\n      function callTool(toolName, params) {\n        return new Promise((resolve, reject) => {\n          const messageId = nextMessageId();\n          pending.set(messageId, { resolve, reject });\n          window.parent.postMessage({ type: \"tool\", payload: { toolName, params }, messageId }, \"*\");\n          setTimeout(() => {\n            if (pending.has(messageId)) {\n              pending.delete(messageId);\n              reject(new Error(\"timeout\"));\n            }\n          }, 20000);\n        });\n      }\n\n      function extractTextFromResponse(response) {\n        if (!response || !Array.isArray(response.content)) return \"\";\n        const item = response.content.find((c) => c && c.text);\n        return item ? item.text : \"\";\n      }\n\n      async function loadNodes() {\n        const parentPath = parentPathInput.value.trim() || \"/project1\";\n        const pattern = patternInput.value.trim() || \"*\";\n        nodesStatus.textContent = \"読み込み中...\";\n        nodesList.innerHTML = \"\";\n        selectedNode = null;\n        renderSelectedNode();\n\n        try {\n          const response = await callTool(\"get_td_nodes\", {\n            parentPath,\n            pattern,\n            detailLevel: \"detailed\",\n            responseFormat: \"json\",\n          });\n          const text = extractTextFromResponse(response);\n          const data = JSON.parse(text);\n          nodes = Array.isArray(data.nodes) ? data.nodes : [];\n          renderNodeList();\n          nodesStatus.textContent = nodes.length ? `${nodes.length}件取得` : \"ノードなし\";\n        } catch (err) {\n          nodesStatus.textContent = \"取得に失敗しました\";\n          paramsStatus.textContent = \"\";\n          console.error(err);\n        }\n      }\n\n      function renderNodeList() {\n        nodesList.innerHTML = \"\";\n        if (!nodes.length) {\n          nodesList.innerHTML = '<div class=\"list-item muted\">ノードなし</div>';\n          return;\n        }\n        nodes.forEach((node) => {\n          const item = document.createElement(\"div\");\n          item.className = \"list-item\" + (selectedNode && selectedNode.path === node.path ? \" active\" : \"\");\n          item.innerHTML = `<div><strong>${node.name}</strong> <span class=\"pill\">${node.opType}</span></div><div class=\"small muted\">${node.path}</div>`;\n          item.onclick = () => {\n            selectNode(node);\n          };\n          nodesList.appendChild(item);\n        });\n      }\n\n      async function selectNode(node) {\n        selectedNode = node;\n        renderSelectedNode();\n        await loadNodeDetails(node.path);\n      }\n\n      function renderSelectedNode() {\n        if (!selectedNode) {\n          selectedNodeLabel.textContent = \"ノードを選択してください\";\n          refreshNodeBtn.disabled = true;\n          paramsContainer.innerHTML = \"\";\n          return;\n        }\n        selectedNodeLabel.textContent = `${selectedNode.path} (${selectedNode.opType})`;\n        refreshNodeBtn.disabled = false;\n      }\n\n      async function loadNodeDetails(nodePath) {\n        paramsStatus.textContent = \"パラメータ取得中...\";\n        paramsContainer.innerHTML = \"\";\n        try {\n          const response = await callTool(\"get_td_node_parameters\", {\n            nodePath,\n            detailLevel: \"detailed\",\n            responseFormat: \"json\",\n          });\n          const text = extractTextFromResponse(response);\n          const data = JSON.parse(text);\n          selectedNode = data;\n          renderSelectedNode();\n          renderParameters(data.properties || {});\n          paramsStatus.textContent = \"取得完了\";\n        } catch (err) {\n          paramsStatus.textContent = \"取得に失敗しました\";\n          console.error(err);\n        }\n      }\n\n      function renderParameters(properties) {\n        paramsContainer.innerHTML = \"\";\n        const entries = Object.entries(properties);\n        if (!entries.length) {\n          paramsContainer.innerHTML = '<div class=\"muted\">パラメータがありません</div>';\n          return;\n        }\n        entries.slice(0, 40).forEach(([key, value]) => {\n          const row = document.createElement(\"div\");\n          row.className = \"param-row\";\n\n          const header = document.createElement(\"div\");\n          header.className = \"param-header\";\n          header.innerHTML = `<div><strong>${key}</strong></div><div class=\"small muted\">${typeOf(value)}</div>`;\n          row.appendChild(header);\n\n          const controls = document.createElement(\"div\");\n          controls.className = \"param-controls\";\n\n          const { inputEl, getValue } = createInputForValue(value);\n          controls.appendChild(inputEl);\n\n          const applyBtn = document.createElement(\"button\");\n          applyBtn.textContent = \"更新\";\n          applyBtn.onclick = async () => {\n            if (!selectedNode) return;\n            applyBtn.disabled = true;\n            paramsStatus.textContent = `${key} 更新中...`;\n            try {\n              const newValue = getValue();\n              await callTool(\"update_td_node_parameters\", {\n                nodePath: selectedNode.path,\n                properties: { [key]: newValue },\n                detailLevel: \"summary\",\n              });\n              paramsStatus.textContent = `${key} を更新しました`;\n            } catch (err) {\n              paramsStatus.textContent = `${key} の更新に失敗しました`;\n              console.error(err);\n            } finally {\n              applyBtn.disabled = false;\n            }\n          };\n\n          controls.appendChild(applyBtn);\n          row.appendChild(controls);\n          paramsContainer.appendChild(row);\n        });\n      }\n\n      function typeOf(value) {\n        if (value === null) return \"null\";\n        if (Array.isArray(value)) return \"array\";\n        return typeof value;\n      }\n\n      function createInputForValue(value) {\n        if (typeof value === \"boolean\") {\n          const checkbox = document.createElement(\"input\");\n          checkbox.type = \"checkbox\";\n          checkbox.checked = Boolean(value);\n          return {\n            inputEl: checkbox,\n            getValue: () => checkbox.checked,\n          };\n        }\n\n        if (typeof value === \"number\" && Number.isFinite(value)) {\n          const wrapper = document.createElement(\"div\");\n          wrapper.style.flex = \"1\";\n\n          const range = document.createElement(\"input\");\n          range.type = \"range\";\n          const span = Math.max(1, Math.abs(value)) || 1;\n          range.min = String(value - span);\n          range.max = String(value + span);\n          range.step = String(span / 50);\n          range.value = String(value);\n          range.style.width = \"100%\";\n\n          const numberInput = document.createElement(\"input\");\n          numberInput.type = \"number\";\n          numberInput.value = String(value);\n          numberInput.step = String(span / 50);\n\n          range.oninput = () => {\n            numberInput.value = range.value;\n          };\n          numberInput.oninput = () => {\n            range.value = numberInput.value || \"0\";\n          };\n\n          wrapper.appendChild(range);\n          wrapper.appendChild(numberInput);\n\n          return {\n            inputEl: wrapper,\n            getValue: () => Number(numberInput.value || \"0\"),\n          };\n        }\n\n        const textInput = document.createElement(\"input\");\n        textInput.type = \"text\";\n        textInput.value = value === undefined || value === null ? \"\" : String(value);\n        return {\n          inputEl: textInput,\n          getValue: () => textInput.value,\n        };\n      }\n\n      document.getElementById(\"loadNodes\").onclick = loadNodes;\n      refreshNodeBtn.onclick = () => {\n        if (selectedNode) {\n          loadNodeDetails(selectedNode.path);\n        }\n      };\n\n      loadNodes();\n    })();\n  </script>\n</body>\n</html>"
}
